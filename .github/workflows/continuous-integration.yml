name: Continuous Integration

on:
  push:
    branches:
      - master
    tags:
      - "*"
  pull_request:

# SECRETS
# - PYPI_TOKEN: publishing token for tmbo account, needs to be maintainer of
#               tmbo/questionary on pypi

jobs:
  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout git repository ğŸ•
        uses: actions/checkout@v3

      - name: Set up Python 3.11 ğŸ
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install poetry ğŸ¦„
        uses: Gr1N/setup-poetry@v8

      - name: Load Poetry Cached Libraries â¬‡
        uses: actions/cache@v3
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: ${{ runner.os }}-poetry-

      - name: Install dependencies ğŸ–¥
        run: poetry install --no-interaction

      - name: Lint Code ğŸ
        run: make lint

      - name: Check Types ğŸ“š
        run: make types

      - name: Check Version Numbers ğŸ•¸
        run: poetry run python scripts/validate_version.py

  test:
    name: Run Tests
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.8", "3.9", "3.10", "3.11"]
        promttoolkit: [3.*, 2.*]
        include:
          - promttoolkit: 3.0.29
            os: ubuntu-latest
          - promttoolkit: 3.0.19
            os: ubuntu-latest

    steps:
      - name: Checkout git repository ğŸ•
        uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }} ğŸ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install poetry ğŸ¦„
        uses: Gr1N/setup-poetry@v8

      - name: Load Poetry Cached Libraries â¬‡
        uses: actions/cache@v3
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: ${{ runner.os }}-poetry-

      - name: Install dependencies ğŸ–¥
        run: |
          poetry install --no-interaction
          poetry run pip install prompt_toolkit==${{ matrix.promttoolkit }}

      - name: Test Code ğŸ”
        run: make test

      - name: Send Coverage Report ğŸ“Š
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COVERALLS_SERVICE_NAME: github
          COVERALLS_PARALLEL: true
        run: poetry run coveralls
  post-test:
    name: Signal test completion
    needs: test
    runs-on: ubuntu-latest
    container: python:3-slim
    steps:
      - name: Finished
        run: |
          pip3 install --upgrade coveralls
          coveralls --service=github --finish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docs:
    name: Test Docs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout git repository ğŸ•
        uses: actions/checkout@v3

      - name: Set up Python 3.11 ğŸ
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install poetry ğŸ¦„
        uses: Gr1N/setup-poetry@v8

      - name: Load Poetry Cached Libraries â¬‡
        uses: actions/cache@v3
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: ${{ runner.os }}-poetry

      - name: Install dependencies ğŸ–¥
        run: poetry install --no-interaction --with=docs

      - name: Build docs âš’ï¸
        run: make docs

  deploy:
    name: Deploy to PyPI
    runs-on: ubuntu-latest

    # deploy will only be run when there is a tag available
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags')
    needs: [quality, test, docs] # only run after all other stages succeeded

    steps:
      - name: Checkout git repository ğŸ•
        uses: actions/checkout@v3

      - name: Set up Python 3.11 ğŸ
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install poetry ğŸ¦„
        uses: Gr1N/setup-poetry@v8

      - name: Build âš’ï¸ Distributions
        run: |
          poetry build
          poetry publish -u __token__ -p ${{ secrets.PYPI_TOKEN }}
